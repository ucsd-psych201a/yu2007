<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Learning Game</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #cfd9df, #e2ebf0);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100%;
      overflow-x: hidden;
      color: #333;
    }

    .jspsych-display-element {
      max-width: 100%;
      text-align: center;
      padding: 50px;
      background: #ffffff;
      box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    .jspsych-display-element:hover {
      transform: scale(1.02);
    }

    .jspsych-html-keyboard-response-stimulus {
      font-size: 1.4em;
      color: #4a4a4a;
      line-height: 1.8;
      margin-bottom: 1.5em;
      text-align: center;
      width: 100%;
    }

    .typing-effect {
      white-space: nowrap;
      overflow: hidden;
      border-right: 2px solid black; 
      display: inline-block;
      width: 0; 
      animation: typing 5s steps(40, end) forwards, blink 0.8s step-end infinite;
    }

    @keyframes typing {
      from {
        width: 0;
      }

      to {
        width: 100%;
      }
    }

    @keyframes blink {
      from,
      to {
        border-color: transparent;
      }

      50% {
        border-color: #4a4a4a;
      }
    }

    .press-any-key {
      opacity: 0;
      font-weight: bold;
      margin-top: 20px;
      transition: opacity 0.5s ease;
    }

    .image-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 20px;
      gap: 80px;
      width: 100%;
      flex-wrap: wrap;
    }

    .image-container img {
      width: 300px;
      height: auto;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    }

    .image-container img:hover {
      transform: scale(1.05);
      box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
    }

    .timer {
      font-size: 2em;
      color: #333;
      margin-top: 10px;
    }

    .countdown-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      position: fixed;
      top: 0;
      left: 0;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 8em;
      font-weight: bold;
      z-index: 100;
    }
  </style>
</head>

<body>
  <script>
    var jsPsych = initJsPsych({
      override_safe_mode: true
    });

    const subject_id = jsPsych.randomization.randomID(10);
    function generateFilename(condition) {
        const timestamp = new Date().toISOString().replace(/:/g, '-');
        return `${subject_id}_condition${condition}_${timestamp}.csv`;
    }
    const condition1_filename = generateFilename(1);

    var timeline = [];

    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="jspsych-html-keyboard-response-stimulus">
          <p>Welcome to the experiment.</p>
          <p>Press any key to begin.</p>
          <div class="press-any-key">Press any key to begin</div>
        </div>
      `,
    };
    timeline.push(welcome);

    var instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="jspsych-html-keyboard-response-stimulus">
          <p id="line1"></p>
          <p id="line2"></p>
          <p id="line3"></p>
          <p id="line4"></p>
          <p id="line5"></p>
          <p id="line6"></p>
          <p id="line7"></p>
          <div class="press-any-key" style="opacity: 0;">Press any key to begin</div>
        </div>
     `,
      on_load: function () {
        const lines = [
          "You will view pairs of images and pseudo-word audios across three conditions: 2x2, 3x3, and 4x4.",
          "Your goal is to learn which word matches each image.",
          "There won't be direct hints, but repetition will help you infer the correct matches.",
          "Each trial lasts 6，9，12 seconds through 3 conditions and changes automatically.",
          "After each condition, you will take a brief test to match images to words.",
          "You're now in the 2x2 condition with 54 trials.",
          "Each trial will display 2 images and 2 words for 6 seconds."
        ];
        
        const typingSpeed = 50;
        const sentenceDelay = 200;  // Define a delay between sentences

        function typeLine(lineIndex) {
          if (lineIndex < lines.length) {
            const element = document.getElementById('line' + (lineIndex + 1));
            let i = 0;
            const typingInterval = setInterval(() => {
              element.textContent += lines[lineIndex][i];
              i++;
              if (i === lines[lineIndex].length) {
                clearInterval(typingInterval);
                element.classList.remove('typing-effect');
                setTimeout(() => {
                  typeLine(lineIndex + 1); // Type the next line with a delay
                }, sentenceDelay);
              }
            }, typingSpeed);
          } else {
            document.querySelector('.press-any-key').style.opacity = 1;
          }
        }

        setTimeout(() => {
          typeLine(0); // Start typing the first line
        }, 500);
      }
    };
    timeline.push(instructions);

    var preload = {
      type: jsPsychPreload,
      images: [
        "https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/image/1.bmp",
        "https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/image/2.bmp"
      ],
      audio: [
        "https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/audio/1.mp3",
        "https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/audio/2.mp3"
      ]
    };
    timeline.push(preload);

    var countdown_3 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div class="countdown-container">3</div>',
      choices: "NO_KEYS",
      trial_duration: 1000
    };

    var countdown_2 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div class="countdown-container">2</div>',
      choices: "NO_KEYS",
      trial_duration: 1000
    };

    var countdown_1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div class="countdown-container">1</div>',
      choices: "NO_KEYS",
      trial_duration: 1000
    };

    const imageBaseURL = "https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/image/";
    const audioBaseURL = "https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/audio/";
    const fileExtensionImage = ".bmp";
    const fileExtensionAudio = ".mp3";

    // Function to shuffle array
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // Swap elements
      }
    }

    // Function to create image-audio trial
    function createImageAudioTrial(image_a, image_b, audio_a, audio_b) {
      var images = [image_a, image_b];
      var audios = [audio_a, audio_b];
      shuffleArray(images);
      shuffleArray(audios);

      var preload = {
        type: jsPsychPreload,
        images: images,
        audio: audios
      };

      var imageAudioTrial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div class="image-container">
            <img src="${images[0]}" alt="Image 1">
            <img src="${images[1]}" alt="Image 2">
          </div>
          <div class="timer">Time Remaining: <span id="timer">6</span> seconds</div>
          <audio id="audio_a">
            <source src="${audios[0]}">
          </audio>
          <audio id="audio_b">
            <source src="${audios[1]}">
          </audio>
         `
        ,
        choices: "NO_KEYS",
        trial_duration: 6000,
        on_load: () => {
          const audio_a = document.getElementById('audio_a');
          const audio_b = document.getElementById('audio_b');
          const timerElement = document.getElementById('timer');
          let startTime = Date.now();
          let timeRemaining = 6;

          const timerInterval = setInterval(() => {
            let currentTime = Date.now();
            let elapsedTime = Math.floor((currentTime - startTime) / 1000);
            timeRemaining = 6 - elapsedTime;
            timerElement.textContent = timeRemaining;
            if (timeRemaining <= 0) {
              clearInterval(timerInterval);
            }
          }, 1000);

          audio_a.play();
          audio_a.onended = function () {
            setTimeout(function () {
              audio_b.play(); // Play the second audio after a delay
            }, 1000);
          };

          // Error handling for audio playback
          audio_a.onerror = () => console.log("Error playing audio_a");
          audio_b.onerror = () => console.log("Error playing audio_b");
        }
      };
      return [preload, imageAudioTrial];
    }

    // Trial mappings
    const trialMappings = [
    { trial: 10, imageA: 1, imageB: 3, audioA: 1, audioB: 3 },
  { trial: 11, imageA: 2, imageB: 4, audioA: 2, audioB: 4 },
  { trial: 12, imageA: 5, imageB: 7, audioA: 5, audioB: 7 },
  { trial: 13, imageA: 6, imageB: 8, audioA: 6, audioB: 8 },
  { trial: 14, imageA: 9, imageB: 11, audioA: 9, audioB: 11 },
  { trial: 15, imageA: 10, imageB: 12, audioA: 10, audioB: 12 },
  { trial: 16, imageA: 13, imageB: 15, audioA: 13, audioB: 15 },
  { trial: 17, imageA: 14, imageB: 16, audioA: 14, audioB: 16 },
  { trial: 18, imageA: 17, imageB: 1, audioA: 17, audioB: 1 },
  { trial: 19, imageA: 2, imageB: 3, audioA: 2, audioB: 3 },
  { trial: 20, imageA: 4, imageB: 5, audioA: 4, audioB: 5 },
  { trial: 21, imageA: 6, imageB: 7, audioA: 6, audioB: 7 },
  { trial: 22, imageA: 8, imageB: 9, audioA: 8, audioB: 9 },
  { trial: 23, imageA: 10, imageB: 11, audioA: 10, audioB: 11 },
  { trial: 24, imageA: 12, imageB: 13, audioA: 12, audioB: 13 },
  { trial: 25, imageA: 14, imageB: 15, audioA: 14, audioB: 15 },
  { trial: 26, imageA: 16, imageB: 17, audioA: 16, audioB: 17 },
  { trial: 27, imageA: 18, imageB: 1, audioA: 18, audioB: 1 },
  { trial: 28, imageA: 2, imageB: 5, audioA: 2, audioB: 5 },
  { trial: 29, imageA: 3, imageB: 6, audioA: 3, audioB: 6 },
  { trial: 30, imageA: 4, imageB: 7, audioA: 4, audioB: 7 },
  { trial: 31, imageA: 8, imageB: 10, audioA: 8, audioB: 10 },
  { trial: 32, imageA: 9, imageB: 12, audioA: 9, audioB: 12 },
  { trial: 33, imageA: 11, imageB: 13, audioA: 11, audioB: 13 },
  { trial: 34, imageA: 14, imageB: 16, audioA: 14, audioB: 16 },
  { trial: 35, imageA: 15, imageB: 17, audioA: 15, audioB: 17 },
  { trial: 36, imageA: 18, imageB: 2, audioA: 18, audioB: 2 },
  { trial: 37, imageA: 3, imageB: 5, audioA: 3, audioB: 5 },
  { trial: 38, imageA: 6, imageB: 8, audioA: 6, audioB: 8 },
  { trial: 39, imageA: 9, imageB: 11, audioA: 9, audioB: 11 },
  { trial: 40, imageA: 12, imageB: 14, audioA: 12, audioB: 14 },
  { trial: 41, imageA: 15, imageB: 18, audioA: 15, audioB: 18 },
  { trial: 42, imageA: 1, imageB: 4, audioA: 1, audioB: 4 },
  { trial: 43, imageA: 5, imageB: 7, audioA: 5, audioB: 7 },
  { trial: 44, imageA: 8, imageB: 10, audioA: 8, audioB: 10 },
  { trial: 45, imageA: 11, imageB: 13, audioA: 11, audioB: 13 },
  { trial: 46, imageA: 16, imageB: 18, audioA: 16, audioB: 18 },
  { trial: 47, imageA: 1, imageB: 6, audioA: 1, audioB: 6 },
  { trial: 48, imageA: 3, imageB: 9, audioA: 3, audioB: 9 },
  { trial: 49, imageA: 5, imageB: 11, audioA: 5, audioB: 11 },
  { trial: 50, imageA: 7, imageB: 13, audioA: 7, audioB: 13 },
  { trial: 51, imageA: 10, imageB: 15, audioA: 10, audioB: 15 },
  { trial: 52, imageA: 12, imageB: 16, audioA: 12, audioB: 16 },
  { trial: 53, imageA: 14, imageB: 18, audioA: 14, audioB: 18 },
  { trial: 54, imageA: 2, imageB: 8, audioA: 2, audioB: 8 }
    ];

    // Randomize trial order
    const randomizedTrials = trialMappings.sort(() => Math.random() - 0.5);

    // Push randomized trials to the timeline
    for (let i = 0; i < randomizedTrials.length; i++) {
      const { imageA, imageB, audioA, audioB } = randomizedTrials[i];
      let imageAURL = `${imageBaseURL}${imageA}${fileExtensionImage}`;
      let imageBURL = `${imageBaseURL}${imageB}${fileExtensionImage}`;
      let audioAURL = `${audioBaseURL}${audioA}${fileExtensionAudio}`;
      let audioBURL = `${audioBaseURL}${audioB}${fileExtensionAudio}`;

      timeline.push(...createImageAudioTrial(imageAURL, imageBURL, audioAURL, audioBURL));
    }

    // Test Instructions
var test_instructions = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="jspsych-html-keyboard-response-stimulus">
    <p>Now that you've completed the learning phase, it's time for a test.</p>
    <p>In each question, you will hear an audio clip and see four images on the screen.</p>
    <p>Your task is to select the image that corresponds to the audio you hear. Use the mouse to select your answer.</p>
    <p>You will not receive feedback during this test, but your performance will be recorded.</p>
    <p>Press any key to begin the test.</p>
    </div>
  `,
};

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// Generate Test Trials
var test_items = Array.from({ length: 18 }, (_, i) => i + 1);
var test_trials = test_items.map((item) => {
  let foils = shuffleArray(test_items.filter((x) => x !== item)).slice(0, 3);
  let options = shuffleArray([item, ...foils]);

  const letterChoices = ["A", "B", "C", "D"];
  const choiceMapping = options.map((option, index) => ({
    label: letterChoices[index],
    value: option,
  }));

  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div style="text-align: center;">
        <p>Listen to the audio and select the matching image:</p>
        <audio src="https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/audio/${item}.mp3" autoplay></audio>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
          ${choiceMapping
            .map(
              (choice) =>
                `<div style="display: flex; flex-direction: column; align-items: center;">
                  <button class="jspsych-btn" style="padding: 0; border: none; background: none;">
                    <img src="https://raw.githubusercontent.com/ucsd-psych201a/yu2007/refs/heads/main/stimuli/condition1/image/${choice.value}.bmp" 
                         alt="Image ${choice.value}" 
                         style="width: 150px; height: 150px; display: block;">
                  </button>
                  <div style="margin-top: 10px; font-weight: bold;">${choice.label}</div>
                </div>`
            )
            .join("")}
        </div>
      </div>
    `,
    choices: letterChoices,
    data: {
      correct_choice: letterChoices[options.indexOf(item)],
      correct_image: `${item}`,
    },
    on_finish: function (data) {
        const letterChoices = ["A", "B", "C", "D"];
        data.response_letter = letterChoices[data.response];
        data.correct = data.response_letter === data.correct_choice;
        data.response_time = data.rt;
},

  };
});

timeline.push(test_instructions);
timeline.push(...test_trials);

var save_data_condition1 = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: "fgtw92SxkLKC",
  filename: condition1_filename,
  data_string: () => jsPsych.data.get().csv(),
};

timeline.push(save_data_condition1);

jsPsych.run(timeline);

  </script>
</body>

</html>